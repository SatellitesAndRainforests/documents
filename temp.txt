import os 
import subprocess 
import shutil

# sudo npm install -g gulp-cli
# sudo npx gulp clean
# sudo npx gulp minified
# sudo npx gulp generic 

PDFJS_REPO = "https://github.com/mozilla/pdf.js"
PDFJS_VERSION = "v4.10.38"
PUBLIC_DIR = "./app/public/pdfjs"
LOCAL_DIR = "local_pdfjs/pdf.js-4.10.38"
TEMP_DIR = "temp_pdfjs"


def clone_pdfjs_to_temp_dir():
    
    print_message(f"cloning prf.js tag version: {PDFJS_VERSION}" )

    if os.path.exists(LOCAL_DIR):
        print_message( "using local clone" )
        shutil.copytree( LOCAL_DIR, TEMP_DIR, dirs_exist_ok=True )
    else:

        subprocess.run(
            [ "git", "clone", "--branch", PDFJS_VERSION, "--depth", "1", PDFJS_REPO, TEMP_DIR ],
            check=True
        )


def build_pdfjs_in_temp_dir():
    
    print_message( "building pdf.js" )

    subprocess.run( [ "npm", "install" ], cwd=TEMP_DIR, check=True )
    subprocess.run( [ "npm", "run", "build", "generic" ], cwd=TEMP_DIR, check=True )


def copy_build_to_app_public(): 

    print_message( "copying to app public/" )

    build_dir = os.path.join( TEMP_DIR, "build")
    web_dir = os.path.join( TEMP_DIR, "web")

    os.makedirs( PUBLIC_DIR, exists_ok=True )
    shutil.copytree( build_dir, os.path.join( PUBLIC_DIR, "build" ), dirs_exist_ok=True )
    shutil.copytree( web_dir, os.path.join( PUBLIC_DIR, "web" ), dirs_exist_ok=True )
    shutil.copy( os.path.join( TEMP_DIR, "LICENSE" ), PUBLIC_DIR )


def clean_up():
    
    print_message(f"cleaning {TEMP_DIR}/" )

    shutil.rmtree( TEMP_DIR, ignore_errors=True )


def print_message(message):
    print(f"\n{ message }\n" )


if __name__ == "__main__":
    
    try:

        clone_pdfjs_to_temp_dir()
        build_pdfjs_in_temp_dir()
        copy_build_to_app_public()

    finally:

        print_message( "finally" )
        # clean_up()






















